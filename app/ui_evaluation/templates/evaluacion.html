{% extends "eval_base.html" %}
{% block content %}
<body>

<div class="container-fluid">
    <h2>{{ ecoe.name }}</h2>
    <h3>{{ station.name }}</h3>
    {% set actual_student = students[1] %}
    <h2>
        <a href="{{ url_for('.evaluacion', id_ecoe=ecoe.id, id_station=station.id, id_shift=id_shift, id_round=id_round, id_student=students[0].id) }}">
            <button type="button" class="btn btn-default btn-sm">
                <span class="glyphicon glyphicon-chevron-left"></span>
            </button></a>
        {% if student_exists %}
            {{ actual_student.name }}
        {% else %}
            No Student
        {% endif %}
        <a href="{{ url_for('.evaluacion', id_ecoe=ecoe.id, id_station=station.id, id_shift=id_shift, id_round=id_round, id_student=students[2].id) }}">
            <button type="button" class="btn btn-default btn-sm">
                <span class="glyphicon glyphicon-chevron-right"></span>
            </button>
        </a>
    </h2>
    {% if student_exists %}
        <table class="table table-striped">
            <tr>
                <th style="width: 60%">Enunciado</th>
                <th>Referencia</th>
                <th>Opciones</th>
            </tr>
            {% for question in questions %}
                {% set question_loop = loop %}
              <tr>
                <td>
                 {{ question_loop.index }}.- {{ question.question.description }}
                </td>
                <td>
                    {{ question.question.reference }}
                </td>
                <td>

                    {% if question.question.question_type == 'RB' and question.options|length > 4 %}
                        <div class="input-group">
                            <select class="custom-select" id="selector{{ question.question.id }}" onchange="postAnswer({{ actual_student.id }}, this.value)">
                                {% for option in question.options %}
                                    <option value="{{ option.id }}" {% if option.checked %}selected{% endif %}>{{ option.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% else %}
                        {% for option in question.options %}
                            <div class="form-check form-check-inline">
    {#                        {% set option_loop = loop %}#}
                            {% if question.question.question_type == 'CH' %}
                                <input type="checkbox"
                                       class="form-check-input"
                                       name="checkbox{{ question.question.id }}"
                                       id="checkbox{{ question.question.id }}{{ option.id }}"
                                       value="{{ option.id }}"
                                        {% if option.checked %}checked{% endif %}
                                       onchange="sendAnswer(this, {{ actual_student.id }}, {{ option.id }})"/>
                                <label class="form-check-label" for="checkbox{{ question.question.id }}{{ option.id }}">{{ option.label }}</label>

                            {% elif question.question.question_type == 'RB' %}
                                <input type="radio"
                                       class="form-check-input"
                                       name="radiobutton{{ question.question.id }}"
                                       id="radiobutton{{ question.question.id }}{{ option.id }}"
                                       value="{{ option.id }}"
                                       placeholder="{{ actual_student.id }}"
                                       {% if option.checked %}checked{% endif %}
                                       onchange="sendAnswer(this, {{ actual_student.id }}, {{ option.id }})">
                                <label class="form-check-label" for="radiobutton{{ question.question.id }}{{ option.id }}">{{ option.label }}</label>
                            {% endif %}
                            </div>
                        {% endfor %}
                    {% endif %}
                </td>
              </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>
</body>
{% endblock %}

{% block scripts %}
    {{ super() }}

    <script>
        function deleteAnswer(id_student, id_option) {
            var delete_url = "{{ url_for('.delete_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: delete_url,
                type: 'DELETE',
                success: function(res) {
                    console.log(res)
                }
            });
        }

        function postAnswer(id_student, id_option) {
            var post_url = "{{ url_for('.send_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: post_url,
                type: 'POST',
                success: function(result) {
                    console.log(result);
                }
            });
        }

        function setupDeselectEvent() {
            var selected = {};
            $('input[type="radio"]').on('click', function() {
                if (this.name in selected && this !== selected[this.name])
                    $(selected[this.name]).trigger("deselect");
                selected[this.name] = this;
            });
        }

        $(document).ready(function() {
            setupDeselectEvent(true);

            $('input[type="radio"]').on('deselect', function() {
                deleteAnswer(this.placeholder, this.value);
            });
        });

        function sendAnswer(htmlElement, id_student, id_option) {
            if (htmlElement.checked) {
                postAnswer(id_student, id_option)
            } else {
                deleteAnswer(id_student, id_option);
            }
        }
    </script>
{% endblock %}
