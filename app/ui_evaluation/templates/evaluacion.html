{% extends "eval_base.html" %}
{% from 'macros.html' import info_chrono_station %}

{% block content %}

<div class="container-fluid">

    {{ info_chrono_station() }}

    <h2>{{ ecoe.name }}</h2>
    <h3>{{ station.name }}</h3>
{#    {% if students|length > 0 %}#}
        {% set actual_student = students[1] %}
        <h2>
            <button type="button" class="btn btn-default btn-sm" onclick="previousStudent()">
                <span class="glyphicon glyphicon-chevron-left"></span>
            </button>
            {{ actual_student.name }}
            <button type="button" class="btn btn-default btn-sm" onclick="nextStudent()">
                <span class="glyphicon glyphicon-chevron-right"></span>
            </button>
        </h2>
{#    {% endif %}#}
    <table class="table table-striped">
        <tr>
            <th>Enunciado</th>
            <th>Referencia</th>
            <th>Opciones</th>
        </tr>
        {% for question in questions %}
            {% set question_loop = loop %}
          <tr>
            <td>
             {{ question_loop.index }}.- {{ question.question.description }}
            </td>
            <td>
                {{ question.question.reference }}
            </td>
            <td>
                <div class="form-check">
                {% for option in question.options %}
                    {% set option_loop = loop %}
                    {% if question.question.question_type == 'CH' %}
                        <input type="checkbox" class="form-check-input" name="checkbox{{ question.question.id }}" id="checkbox{{ question.question.id }}{{ option.id }}" value="{{ option.id }}" onchange="sendAnswer(this, 1, {{ option.id }})"/>
                        <label class="form-check-label" for="checkbox{{ question.question.id }}{{ option.id }}">{{ option.label }}</label>
                    {% endif %}
                    {% if question.question.question_type == 'RB' %}
                        <input type="radio" class="form-check-input" name="radiobutton{{ question.question.id }}" id="radiobutton{{ question.question.id }}{{ option.id }}" value="{{ option.id }}" onchange="sendAnswer(this, 1, {{ option.id }})">
                        <label class="form-check-label" for="radiobutton{{ question.question.id }}{{ option.id }}">{{ option.label }}</label>
                    {% endif %}
                {% endfor %}
                </div>
            </td>
          </tr>
        {% endfor %}
    </table>
</div>

{% endblock %}

{% block scripts %}
    {{ super() }}

    <script type='text/javascript' src="{{ url_for('static', filename='js/socket.io.min.js') }}" ></script>

    <script>
        function deleteAnswer(id_student, id_option) {
            var delete_url = "{{ url_for('.delete_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: delete_url,
                type: 'DELETE',
                success: function(res) {
                    console.log(res)
                }
            });
        }

        function postAnswer(id_student, id_option) {
            var post_url = "{{ url_for('.send_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: post_url,
                type: 'POST',
                success: function(result) {
                    console.log(result);
                }
            });
        }

        function setupDeselectEvent() {
            var selected = {};
            $('input[type="radio"]').on('click', function() {
                if (this.name in selected && this !== selected[this.name])
                    $(selected[this.name]).trigger("deselect");
                selected[this.name] = this;
            });
        }

        function instant(minutes, seconds) {
            return "[" + minutes + ":" + seconds + "]";
        }

        $(document).ready(function() {

            /*** SOCKETS ***/

            var socket = io.connect('{{ chrono_route }}');

            socket.on('connect', function () {
                //$("#log").append('Estación {{ station.id }}: conectada a rueda {{ id_round }}<br>');
                console.log('Estación {{ station.id }}: conectada a rueda {{ id_round }}')
            });

            socket.on('end_round', function(msg) {
                $('#clock').css("color", "green").show('slow');
                //$('#log').append("<span style='color:blue'>"+msg.data+"</span><br>");
                console.log(msg.data)
            });

            socket.on('init_stage', function(msg) {
                $('#clock').fadeOut('fast').fadeIn('fast');
            });

            socket.on('evento', function(msg) {
                if (jQuery.inArray({{ station.id }}+"", msg.target.split(",")) >= 0) {
                    //$('#log').append("<span style='color:green'>[" + msg.stage + "] " + msg.data + " => " + msg.target + "</span><br>");
                    console.log("[" + msg.stage + "] " + msg.data + " => " + msg.target)
                }
            });

            socket.on('tic_tac', function(msg) {
                $('#clock').text(msg.stage + " " + msg.minutes + ":" + msg.seconds);

                if (msg.stopped == 'S') {
                    $('#clock').css("color", "red");
                    //$('#log').append("<span style='color:red'>"+instant(msg.minutes, msg.seconds)+" Crono parado</span><br>");
                    console.log(instant(msg.minutes, msg.seconds)+" Crono parado");
                }
                else
                    $('#clock').css("color", "black");
            });

            /*** END SOCKETS ***/

            setupDeselectEvent(true);

            $('input[type="radio"]').on('deselect', function() {
                //alert('Radio ' + this.value + ' deselected');
                deleteAnswer(1, this.value);
            });
        });

        function sendAnswer(htmlElement, id_student, id_option) {
            if (htmlElement.checked) {
                postAnswer(id_student, id_option)
            } else {
                deleteAnswer(id_student, id_option);
            }
        }

        function nextStudent() {
            var nextStudent = {{ students[0] }};
        }

        function previousStudent() {
            var prevStudent = {{ students[2] }};
        }
    </script>
{% endblock %}
