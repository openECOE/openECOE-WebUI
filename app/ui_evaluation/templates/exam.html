{% extends "bootstrap/base.html" %}
{% block content %}
<body>
{% set actual_student = students[1] %}

<div class="container">
    <div class="row">
        <div class="col-xs-4 text-left">
            <h3>{{ ecoe.name }}</h3>
        </div>
        <div class="col-xs-8 text-right">
            <h2>{{ station.name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-8">
            Chrono
        </div>
        <div class="col-xs-4 text-right">
            <table class="table table-condensed text-center">
                <thead>
                    <tr>
                        <td>DÃ­a - Turno</td>
                        <td>Rueda</td>
                        <td>Num</td>
                    </tr>
                </thead>
                <tbody>
                    <tr class="lead">
                        <td>{{ shift.shift_code }}</td>
                        <td>{{ round.round_code  }}</td>
                        <td>
                            <a href="{{ url_for('.exam', id_ecoe=ecoe.id, id_station=station.id, id_shift=shift.id, id_round=round.id, order_student=students[0].planner_order) }}">
                                <button type="button" class="btn btn-default btn-sm btn-warning">
                                    <span class="glyphicon glyphicon-chevron-left"></span>
                                </button></a>
                            {% if student_exists %}
                                {{ actual_student.planner_order }}
                            {% else %}
                                <span class="text-danger">No</span>
                            {% endif %}
                            <a href="{{ url_for('.exam', id_ecoe=ecoe.id, id_station=station.id, id_shift=shift.id, id_round=round.id, order_student=students[2].planner_order) }}">
                                <button type="button" class="btn btn-default btn-sm btn-info">
                                    <span class="glyphicon glyphicon-chevron-right"></span>
                                </button></a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    {% if not student_exists %}
        <div class="col-xs-offset-4 col-xs-4">
            <div class="panel panel-danger">
              <div class="panel-heading">Turno sin Alumno</div>
              <div class="panel-body">Este turno no dispone de alumno asignado, por favor espere al siguiente turno.</div>
            </div>
        </div>
    {% else %}
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th class="col-xs-1">Num</th>
                    <th class="col-xs-7">Enunciado</th>
                    <th class="col-xs-2">Referencia</th>
                    <th class="col-xs-2">Opciones</th>
                </tr>
            </thead>
            <tbody>
            {% for question in questions %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ question.question.description }}</td>
                    <td>{{ question.question.reference }}</td>
                    <td>
                        {% if question.question.question_type == 'RB' and question.options|length > 4 %}
                            <div class="input-group">
                                <select class="custom-select" id="selector{{ question.question.id }}"
                                        onchange="postAnswer({{ actual_student.id }}, this.value)">
                                    {% for option in question.options %}
                                        <option value="{{ option.id }}"
                                                {% if option.checked %}selected{% endif %}>{{ option.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% else %}
                            {% for option in question.options %}
                                <div class="form-check form-check-inline">
                                    {#                        {% set option_loop = loop %}#}
                                    {% if question.question.question_type == 'CH' %}
                                        <input type="checkbox"
                                               class="form-check-input"
                                               name="checkbox{{ question.question.id }}"
                                               id="checkbox{{ question.question.id }}{{ option.id }}"
                                               value="{{ option.id }}"
                                               {% if option.checked %}checked{% endif %}
                                               onchange="sendAnswer(this, {{ actual_student.id }}, {{ option.id }})"/>
                                        <label class="form-check-label" for="checkbox
                                                {{ question.question.id }}{{ option.id }}">{{ option.label }}</label>

                                    {% elif question.question.question_type == 'RB' %}
                                        <input type="radio"
                                               class="form-check-input"
                                               name="radiobutton{{ question.question.id }}"
                                               id="radiobutton{{ question.question.id }}{{ option.id }}"
                                               value="{{ option.id }}"
                                               placeholder="{{ actual_student.id }}"
                                               {% if option.checked %}checked{% endif %}
                                               onchange="sendAnswer(this, {{ actual_student.id }}, {{ option.id }})">
                                        <label class="form-check-label" for="radiobutton
                                                {{ question.question.id }}{{ option.id }}">{{ option.label }}</label>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}

</div>
</body>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        var csrf_token = "{{ csrf_token() }}";

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                }
            }
        });

        function deleteAnswer(id_student, id_option) {
            var delete_url = "{{ url_for('.delete_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: delete_url,
                type: 'DELETE',
                success: function(res) {
                    console.log(res)
                }
            });
        }

        function postAnswer(id_student, id_option) {
            var post_url = "{{ url_for('.send_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: post_url,
                type: 'POST',
                success: function(result) {
                    console.log(result);
                }
            });
        }

        function setupDeselectEvent() {
            var selected = {};
            $('input[type="radio"]').on('click', function() {
                if (this.name in selected && this !== selected[this.name])
                    $(selected[this.name]).trigger("deselect");
                selected[this.name] = this;
            });
        }

        $(document).ready(function() {
            setupDeselectEvent(true);

            $('input[type="radio"]').on('deselect', function() {
                deleteAnswer(this.placeholder, this.value);
            });
        });

        function sendAnswer(htmlElement, id_student, id_option) {
            if (htmlElement.checked) {
                postAnswer(id_student, id_option)
            } else {
                deleteAnswer(id_student, id_option);
            }
        }
    </script>

{% endblock %}
