{% extends "app_base.html" %}
{% from 'macros.html' import info_chrono_station, client_eval_socket %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-md-6">
                <h3>
                    <a href="{{ url_for('.evaladmin', id_ecoe=ecoe.id, id_round=planner.round.id, id_station=station.id) }}">
                        <span class="glyphicon glyphicon-chevron-left"></span>
                        Estación {{ station.order }} - {{ station.name }}
                    </a>
                </h3>
                <div>{{ info_chrono_station() }}</div>
            </div>
            <div class="col-xs-12 col-md-6 text-right">
                <h3>{{ student.surnames }}, {{ student.name }}</h3>
                <table class="table table-condensed text-center">
                    <thead>
                    <tr>
                        <td>Día - Turno</td>
                        <td>Rueda</td>
                        <td>Num</td>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="lead">

                        <td>{{ planner.shift.shift_code }}</td>
                        <td>{{ planner.round.round_code }}</td>
                        <td class="row">
                            <div class="col-xs-12 col-md-5">
                                <a class="btn btn-warning btn-block"
                                   role="button"
                                   href="{{ url_for('.exam', id_ecoe=ecoe.id, id_station=station.id, id_shift=planner.shift.id, id_round=planner.round.id, order_student=previous_student) }}">
                                    <span class="glyphicon glyphicon-chevron-left"></span>
                                </a>
                            </div>
                            <div class="col-xs-12 col-md-2 text-center">{{ order_student }}</div>
                            <div class="col-xs-12 col-md-5">
                                <a class="btn btn-info btn-block"
                                   role="button"
                                   href="{{ url_for('.exam', id_ecoe=ecoe.id, id_station=station.id, id_shift=planner.shift.id, id_round=planner.round.id, order_student=next_student) }}">
                                    <span class="glyphicon glyphicon-chevron-right"></span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {% if not student %}
            <div class="col-md-offset-4 col-xs-12 col-md-4">
                <div class="panel panel-danger">
                    <div class="panel-heading">Turno sin Alumno</div>
                    <div class="panel-body">Este turno no dispone de alumno asignado, por favor espere al siguiente
                        turno.
                    </div>
                </div>
            </div>
        {% else %}
            {% for qblock in qblocks %}
                <table class="table table-striped table-hover">
                    <thead>
                    <h4><span
                                    class="label label-success">{{ qblock.name }} ({{ qblock.questions|length }})</span>
                            </h4>
                    <tr>
                        <th class="col-xs-1">
                            <span>Num</span>
                        </th>
                        <th class="col-xs-7">Enunciado</th>
                        <th class="col-xs-2">Referencia</th>
                        <th class="col-xs-2">Opciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for question in qblock.questions|sort(attribute='order') %}
                        <tr>
                            <td>{{ question.order }}</td>
                            <td>{{ question.description }}</td>
                            <td>{{ question.reference }}</td>
                            <td>
                                {% if question.question_type == 'RB' and question.options|length > 4 %}
                                    <div class="input-group">
                                        <select class="custom-select" id="selector{{ question.id }}"
                                                onchange="postAnswer({{ student.id }}, this.value)">
                                            {% for option in question.options|sort(attribute='order') %}
                                                <option value="{{ option.id }}"
                                                        {% if option in student.answers %}selected{% endif %}>{{ option.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                {% else %}
                                    <div class="row form-check form-check-inline">
                                        {% for option in question.options|sort(attribute='order') %}
                                            <h4 class="col col-xs-12 col-sm-{{ (12 / question.options|length)|int }}">
                                                {% if question.question_type == 'CH' %}
                                                    <label class="form-check-label">
                                                        <input type="checkbox"
                                                               class="form-check-input"
                                                               name="checkbox{{ question.id }}"
                                                               value="{{ option.id }}"
                                                               {% if option in student.answers %}checked{% endif %}
                                                               onchange="sendAnswer(this, {{ student.id }}, {{ option.id }})"/>
                                                        {{ option.label }}
                                                    </label>

                                                {% elif question.question_type == 'RB' %}
                                                    <label class="form-check-label">
                                                        <input type="radio"
                                                               class="form-check-input"
                                                               name="radiobutton{{ question.id }}"
                                                               value="{{ option.id }}"
                                                               placeholder="{{ student.id }}"
                                                               {% if option in student.answers %}checked{% endif %}
                                                               onchange="sendAnswer(this, {{ student.id }}, {{ option.id }})">
                                                        {{ option.label }}
                                                    </label>
                                                {% endif %}
                                            </h4>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endfor %}
        {% endif %}
        <div class="col-md-offset-8 col-xs-12 col-md-4 text-right">
            <a class="btn btn-info btn-lg btn-block"
               role="button"
               href="{{ url_for('.exam', id_ecoe=ecoe.id, id_station=station.id, id_shift=planner.shift.id, id_round=planner.round.id, order_student=next_student) }}">

                Siguiente alumno
                <span class="glyphicon glyphicon-chevron-right"></span>
            </a>
        </div>
    </div>

    {{ super() }}
{% endblock %}


{% block scripts %}
    {{ super() }}

    <script type='text/javascript' src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>

    <script>
        var csrf_token = "{{ csrf_token() }}";

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                }
            }
        });

        function deleteAnswer(id_student, id_option) {
            var delete_url = "{{ url_for('.delete_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: delete_url,
                type: 'DELETE',
                success: function (res) {
                    console.log(res)
                }
            });
        }

        function postAnswer(id_student, id_option) {
            var post_url = "{{ url_for('.send_answer', id_student='.id_student.', id_option='.id_option.') }}"
                .replace('.id_student.', id_student)
                .replace('.id_option.', id_option);

            $.ajax({
                url: post_url,
                type: 'POST',
                success: function (result) {
                    console.log(result);
                }
            });
        }

        function setupDeselectEvent() {
            var selected = {};
            $('input[type="radio"]').on('click', function () {
                if (this.name in selected && this !== selected[this.name])
                    $(selected[this.name]).trigger("deselect");
                selected[this.name] = this;
            });
        }

        $(document).ready(function () {

            {{ client_eval_socket(chrono_route, station.id, planner.round.id) }}

            setupDeselectEvent(true);

            $('input[type="radio"]').on('deselect', function () {
                deleteAnswer(this.placeholder, this.value);
            });
        });

        function sendAnswer(htmlElement, id_student, id_option) {
            if (htmlElement.checked) {
                postAnswer(id_student, id_option)
            } else {
                deleteAnswer(id_student, id_option);
            }
        }
    </script>

{% endblock %}
